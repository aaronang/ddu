<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <style>
    .node {
      cursor: pointer;
      stroke: #4292c6;
    }

    .node:hover {
      stroke: #08519c;
      stroke-width: 1.5px;
    }

    .node--leaf {
      fill: #f0f0f0;
    }

    .label {
      font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
      text-anchor: middle;
      stroke: #f0f0f0;
      stroke-width: 3px;
      fill: #525252;
      paint-order: stroke;
    }

    .label,
    .node--root {
      pointer-events: none;
    }
  </style>
</head>

<body>
  <svg width="700" height="700"></svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="jpacman.js"></script>
  <script>
    var svg = d3.select("svg"),
      margin = 20,
      diameter = +svg.attr("width"),
      g = svg.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

    var color = d3.scaleLinear()
      .domain([0, 1])
      .range(['#9ecae1', '#08519c']);

    var colors = {
      'selected': '#4d4d4d',
      'unselected': '#f0f0f0',
      'exclusive': 'a6d96a',
      'inclusive': 'fee08b',
      'untested': 'f46d43'
    }

    var pack = d3.pack()
      .size([diameter - margin, diameter - margin])
      .padding(2);

    root = d3.hierarchy(mydata.tree)
      .sum(function(d) {
        return d.children ? 0 : 1;
      })
      .sort(function(a, b) {
        return b.value - a.value;
      });

    var focus = root,
      nodes = pack(root).descendants(),
      view;

    var circle = g.selectAll("circle")
      .data(nodes)
      .enter().append("circle")
      .attr("class", function(d) {
        return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root";
      })
      .style("fill", function(d) {
        return d.children ? color(d.data.ddu) : null;
      })
      .on("click", function(d) {
        if (!d.children) handleLeafClick(d), d3.event.stopPropagation();
        else if (focus !== d) zoom(d), d3.event.stopPropagation();
      });

    var selectedNodes = [];

    function handleLeafClick(d) {
      console.log(d);
      if (d.data.cid >= 0) {
        if (isSelectedNode(d.data.cid)) {
          selectedNodes.splice(selectedNodes.indexOf(d.data.cid), 1);
        } else {
          selectedNodes.push(d.data.cid)
        }
        update();
      }
    }

    function update() {
      d3.select('svg').selectAll('circle').style("fill", (d) => {
        if (d.children) {
          return color(d.data.ddu);
        } else if (selectedNodes.includes(d.data.cid)) {
          return colors.selected;
        } else {
          return updateLeaf(d);
        }
      })
    }

    function containsAll(a, b) {
      return b.every((x) => a.includes(x));
    }

    function updateLeaf(d) {
      if (selectedNodes.length == 0) {
        return colors.unselected;
      }
      var nodes = selectedNodes.concat(d.data.cid);
      var tests = mydata.tests.filter((t) => containsAll(t, nodes));
      if (tests.some((t) => t.length == nodes.length)) {
        return colors.exclusive;
      } else if (tests.length != 0) {
        return colors.inclusive;
      } else {
        return colors.untested;
      }
    }

    function isSelectedNode(cid) {
      return selectedNodes.includes(cid);
    }

    var text = g.selectAll("text")
      .data(nodes)
      .enter().append("text")
      .attr("class", "label")
      .style("fill-opacity", function(d) {
        return d.parent === root ? 1 : 0;
      })
      .style("display", function(d) {
        return d.parent === root ? "inline" : "none";
      })
      .text(function(d) {
        return d.data.name;
      });

    var node = g.selectAll("circle,text");

    svg
      .style("background", 'color(-1)')
      .on("click", function() {
        zoom(root);
      });

    zoomTo([root.x, root.y, root.r * 2 + margin]);

    function zoom(d) {
      focus = d;

      var transition = d3.transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .tween("zoom", function(d) {
          var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2 + margin]);
          return function(t) {
            zoomTo(i(t));
          };
        });

      transition.selectAll("text")
        .filter(function(d) {
          return d.parent === focus || this.style.display === "inline";
        })
        .style("fill-opacity", function(d) {
          return d.parent === focus ? 1 : 0;
        })
        .on("start", function(d) {
          if (d.parent === focus) this.style.display = "inline";
        })
        .on("end", function(d) {
          if (d.parent !== focus) this.style.display = "none";
        });
    }

    function zoomTo(v) {
      var k = diameter / v[2];
      view = v;
      node.attr("transform", function(d) {
        return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")";
      });
      circle.attr("r", function(d) {
        return d.r * k;
      });
    }
  </script>

</body>

</html>
